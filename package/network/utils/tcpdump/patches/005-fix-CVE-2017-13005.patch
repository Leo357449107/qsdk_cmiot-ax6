From b45a9a167ca6a3ef2752ae9d48d56ac14b001bfd Mon Sep 17 00:00:00 2001
From: Francois-Xavier Le Bail <devel.fx.lebail@orange.fr>
Date: Thu, 23 Feb 2017 16:50:18 +0100
Subject: [PATCH] CVE-2017-13005/NFS: Add two bounds checks before fetching
 data

This fixes a buffer over-read discovered by Kamil Frankowicz.

Add a test using the capture file supplied by the reporter(s).
---
Index: tcpdump-4.9.3/print-nfs.c
===================================================================
--- tcpdump-4.9.3.orig/print-nfs.c
+++ tcpdump-4.9.3/print-nfs.c
@@ -899,7 +899,11 @@ xid_map_enter(netdissect_options *ndo,
 		UNALIGNED_MEMCPY(&xmep->client, &ip6->ip6_src, sizeof(ip6->ip6_src));
 		UNALIGNED_MEMCPY(&xmep->server, &ip6->ip6_dst, sizeof(ip6->ip6_dst));
 	}
+	if (!ND_TTEST(rp->rm_call.cb_proc))
+		return (0);
 	xmep->proc = EXTRACT_32BITS(&rp->rm_call.cb_proc);
+	if (!ND_TTEST(rp->rm_call.cb_vers))
+		return (0);
 	xmep->vers = EXTRACT_32BITS(&rp->rm_call.cb_vers);
 	return (1);
 }
